<div class="layuimini-container layuimini-page-anim">
    <div class="layuimini-main">

        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>填写会议基础内容</legend>
        </fieldset>

        <form class="layui-form" action="" id="form" name="form" th:object="${meeting}">

            <!--隐藏id
            id
            -->
            <div class="layui-form-item layui-form-text">
                <input id="id" name="id" type="text" class="layui-input"
                       th:value="*{id}" style="display: none;">
            </div>
            <!--富文本编辑器-->
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">会议纪要</label>
                <div class="layui-input-inline" id="editor">   <!--style="margin: 100px 0 100px 0"-->
                </div>
            </div>
            <!--隐藏的文本域，用于同步富文本中的文本内容，然后向后台传值
            content
            -->
            <div class="layui-form-item layui-form-text" >
                <div class="layui-input-block">
                    <textarea id="content" name="content" class="layui-textarea" style="display: none;"></textarea>
                </div>
            </div>
            <!--会议中提出的问题
            question
            -->
            <div class="layui-form-item layui-form-text">
                <label class="layui-form-label">会议中提出的问题</label>
                <div class="layui-input-block">
                    <textarea id="question" name="question" placeholder="请输入内容" class="layui-textarea" th:text="*{question}"></textarea>
                </div>
            </div>
            <!--参与人员
            partner
            -->
            <div class="layui-form-item">
                <label class="layui-form-label">参与人员</label>
                <div class="layui-input-block">
                    <input id="partner" name="partner" type="text"  lay-verify="title" autocomplete="off"
                           placeholder="请输入内容" class="layui-input" th:value="*{partner}">
                </div>
            </div>
            <!--组织人员
            organize
            -->
            <div class="layui-form-item">
                <label class="layui-form-label">会议组织者</label>
                <div class="layui-input-block">
                    <input id="organize" name="organize" type="text"  lay-verify="title" autocomplete="off"
                           placeholder="会议组织者" class="layui-input" th:value="*{organize}">
                </div>
            </div>
            <!--会议类型
            type
            -->
            <div class="layui-form-item">
                <label class="layui-form-label">会议类型</label>
                <div class="layui-input-block">
                    <select id="type" name="type" lay-filter="type">
                        <option value=""></option>
                        <option value="项目进度会议" th:selected="${meeting.type == '项目进度会议'}">项目进度会议</option>
                        <option value="工作部署会议" th:selected="${meeting.type == '工作部署会议'}">工作部署会议</option>
                        <option value="交流会" th:selected="${meeting.type == '交流会'}">交流会</option>
                    </select>
                </div>
            </div>
            <!--开会时间
            meetingTime
            -->
            <div class="layui-inline">
                <label class="layui-form-label">开会日期</label>
                <div class="layui-input-inline">
                    <input id="meetingTime" name="meetingTime" class="layui-input" type="text" lay-verity="date"
                           placeholder="yyyy-MM-dd" autocomplete="off" th:value="*{meetingTime}">
                </div>
            </div>
            <!--立即提交和重置-->
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit="" lay-filter="submitAll">立即提交</button>
                    <button id="resetBtn" type="reset" class="layui-btn layui-btn-primary">恢复初始状态</button>
                </div>
            </div>

        </form>

    </div>
</div>



<!----------------------------以下复用编辑页面代码-------------------------------->
<!--
1、修改“初始化editor”功能，回显富文本数据
2、修改“表单提交”，由新增修改为更新
3、修改“重置”，由之前的只能重置富文本，到重置整个表单
4、富文本第一次渲染的时候，需要同步到隐藏域

thymeleaf中的下拉框(select option)回显选中
https://blog.csdn.net/Hellowenpan/article/details/88680627
-->
<!--渲染select-->
<script type="text/javascript">
    layui.use(['form'], function () {
        layui.form.render("select");
    });
</script>

<!--处理日期的显示-->
<script type="text/javascript">
    layui.use(['form', 'laydate'], function () {
        var laydate = layui.laydate;
        laydate.render({
            elem: '#meetingTime'
        })
    })
</script>

<!--处理表单提交-->
<script type="text/javascript">
    layui.use(['form', 'layer', 'laydate'], function () {
        var $ = layui.jquery, layer = layui.layer, element = layui.element;
        var form = layui.form;
        form.on('submit(submitAll)', function (data) {
            console.log("当前容器的全部表单字段\n" + JSON.stringify(data.field)); //当前容器的全部表单字段，名值对形式：{name: value}
            var meetingContent = JSON.stringify(data.field);
            //console.log( "ssssss\n" + JSON.stringify($('#form').serialize()));
            $.ajax({
                url: 'meeting/UpdateMeeting',
                type: 'post',
                dataType: 'text',  //从后台返回的值的类型
                contentType: 'application/json',
                data: meetingContent,
                //在后台设置的1为成功，0为失败
                success: function (data1) {
                    console.log(data1);
                    console.log("ajax返回值：\n" + JSON.stringify(data1.field));
                    if (data1 == '1'){
                        //layer.msg("上传成功！");
                        //关闭当前窗口，强制刷新父窗口
                        layer.close(layer.index);
                        window.parent.location.reload();
                    }
                    else if (data1 == '0'){
                        layer.msg("更新失败");
                    }

                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    // 状态码
                    console.log(XMLHttpRequest.status);
                    // 状态
                    console.log(XMLHttpRequest.readyState);
                    // 错误信息
                    console.log(textStatus);
                    // 打印堆栈
                    //console.log(errorThrown);
                }
            });

            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });
    });
</script>

<!--重置所有-->
<script type="text/javascript" th:inline="javascript">
    var $ = layui.jquery;
    var meetingContent = [[${meeting.content}]];//暂存最开始的数据
    $('#resetBtn').click(function () {
        console.log("使用reset");
        layui.use('wangEditor', function () {
            var wangEditor = layui.wangEditor;
            var editor = new wangEditor('#editor');
            console.log(editor == null);
        });
        layui.use(['form', 'jquery', 'layer'], function () {
            var form = layui.form;
            //先保存meeting的id
            var id = $('#id').val();
            console.log("reset时，记住的隐藏域的值："+meetingContent);
            form.render(); //更新全部
            console.log("reset时，记住的隐藏域的值："+meetingContent);
            //重置富文本编辑器中的内容
            initEditor(meetingContent);


            //$('#content').val(meetingContent);  //这里没有用的原因是textarea要回显的话，需要用$('#content').text
                                                  //form提交数据的时候也是读的$('#content').text
            console.log("重置操作完毕");
        });

    });

</script>

<!--初始化editor-->
<script type="text/javascript" th:inline="javascript">
    var meetingContent = [[${meeting.content}]];
    console.log("后端获取的会议内容信息（meetingContent）：" + meetingContent);
    initEditor(meetingContent);
    function initEditor(mContent) {
        layui.use(['layer', 'wangEditor'], function () {
            var $ = layui.jquery,
                layer = layui.layer,
                wangEditor = layui.wangEditor;
            var editor = new wangEditor('#editor');
            //这里默认为true，即表示能够使用网络图片
            editor.customConfig.showLinkImg = false;

            //过滤掉复制文本的样式  此处关闭了该功能
            editor.customConfig.pasteFilterStyle = false;

            //自定义上传
            editor.customConfig.customUploadImg = async  (files, insert) => {
                var daw = new FormData();
                for (var i = 0; i < files.length; i++) {
                    daw.append("pictures", files[i]);
                    console.log(files[i].name)
                }
                console.log("打印FormData  " + daw.toString());
                for (var [a, b] of daw.entries()) {
                    console.log(a, b);
                }
                index = layer.load(1, {
                    shade: [0.1, '#fff'] //0.1透明度的白色背景
                });

                $.ajax({
                    url: "meeting/submitMulti",
                    type: "POST",
                    data: daw,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (result) {
                        layer.close(index);
                        if (result.code == 0) {
                            for (var j = 0; j < result.data.length; j++) {
                                insert(result.data[j]);
                            }
                        } else {
                            layer.msg(da.msg);
                            return;
                        }
                    },
                });
            };
            editor.customConfig.customAlert = function (info) {
                layer.msg(info);
            }

            //将隐藏域的同步修改到这个位置
            editor.customConfig.onchange = function (html) {
                console.log("变化：" + html);
                $('#content').val(html);
            }

            editor.create();
            editor.txt.clear();
            editor.txt.html(mContent);
            // 复用 同步到隐藏域的代码， 可以避免update页面渲染出来的时候，
            // 没有及时同步到隐藏域content中
            $('#content').val(mContent);
            $('#content').text(mContent);
        });
    }
</script>
